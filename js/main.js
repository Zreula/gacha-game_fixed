// Variables globales du jeu
let gameState = {
    ownedCharacters: new Set(),
    equippedCharacters: new Set(),
    characterEquipment: {},
    totalSummons: 0,
    legendaryCount: 0,
    playerGold: 256,  // Valeur par d√©faut pour test
    crystals: 2,      // Valeur par d√©faut pour test
    currentFilter: 'all',
    activeMissions: {},
    idleMissions: {}
};

// Initialisation du jeu
document.addEventListener('DOMContentLoaded', function() {
    console.log(`üéÆ Gacha Game v${GAME_CONFIG ? GAME_CONFIG.VERSION : '1.0.0'} - Initialisation...`);
    
    // Attendre que tous les scripts soient charg√©s
    setTimeout(() => {
        initializeGame();
    }, 100);
});

function initializeGame() {
    try {
        console.log('üöÄ D√©but de l\'initialisation...');
        
        // V√©rifier que les modules sont charg√©s
        if (typeof UI === 'undefined') {
            console.warn('‚ö†Ô∏è Module UI non charg√©, initialisation basique...');
            initializeBasicGame();
            return;
        }
        
        // 1. Initialiser l'interface utilisateur
        UI.init();
        EquipmentSystem.init();
        ShopSystem.init();

        // 2. Initialiser le syst√®me de sauvegarde
        if (typeof SaveSystem !== 'undefined') {
            SaveSystem.init();
            
            // 3. Charger une sauvegarde existante ou cr√©er un nouveau jeu
            if (!SaveSystem.loadGame()) {
                createNewGame();
            }
        } else {
            console.warn('‚ö†Ô∏è SaveSystem non charg√©, cr√©ation d\'un nouveau jeu...');
            createNewGame();
        }
        
        // 4. Initialiser les syst√®mes de jeu
        if (typeof GachaSystem !== 'undefined') GachaSystem.init();
        if (typeof CombatSystem !== 'undefined') CombatSystem.init();
        if (typeof CollectionSystem !== 'undefined') CollectionSystem.init();
        if (typeof EquipmentSystem !== 'undefined') EquipmentSystem.init();
        if (typeof ShopSystem !== 'undefined') ShopSystem.init();
        
        // 5. Mettre √† jour l'interface
        updateAllUI();
        
        // 6. D√©marrer la sauvegarde automatique si activ√©e
        if (GAME_CONFIG && GAME_CONFIG.SAVE && GAME_CONFIG.SAVE.AUTO_SAVE && typeof SaveSystem !== 'undefined') {
            startAutoSave();
        }
        
        // 7. Ajouter les gestionnaires d'√©v√©nements globaux
        setupGlobalEventListeners();
        
        console.log('‚úÖ Jeu initialis√© avec succ√®s !');
        
    } catch (error) {
        console.error('‚ùå Erreur lors de l\'initialisation:', error);
        console.log('üîß Tentative d\'initialisation basique...');
        initializeBasicGame();
    }
}

function initializeBasicGame() {
    // Initialisation minimale si les modules principaux ne sont pas charg√©s
    console.log('üîß Mode de r√©cup√©ration activ√©...');
    
    createNewGame();
    updateBasicUI();
    setupBasicEventListeners();
    
    console.log('‚úÖ Initialisation basique termin√©e');
}

function createNewGame() {
    console.log('üÜï Cr√©ation d\'un nouveau jeu...');
    
    // R√©initialiser l'√©tat du jeu
    gameState.ownedCharacters.clear();
    gameState.equippedCharacters.clear();
    gameState.characterEquipment = {};
    gameState.totalSummons = 0;
    gameState.legendaryCount = 0;
    gameState.playerGold = 256;
    gameState.crystals = 2;
    gameState.currentFilter = 'all';
    
    // Ajouter George le Noob comme personnage de d√©part
    if (typeof CHARACTERS_DB !== 'undefined') {
        const george = CHARACTERS_DB.find(char => char.name === "George le Noob");
        if (george) {
            gameState.ownedCharacters.add("George le Noob");
            gameState.equippedCharacters.add("George le Noob");
            gameState.characterEquipment["George le Noob"] = { 
                weapon: "‚öîÔ∏è"
            };
            console.log('üë§ George le Noob ajout√© comme personnage de d√©part');
        }
    }
}

function updateAllUI() {
    // Mettre √† jour tous les √©l√©ments d'interface (avec v√©rifications)
    if (typeof UI !== 'undefined') {
        UI.updateStats();
        UI.updatePlayerResources();
    }
    
    if (typeof CollectionSystem !== 'undefined') {
        CollectionSystem.updateCollection();
    }
    
    if (typeof CombatSystem !== 'undefined') {
        CombatSystem.updateCombatInfo();
    }
    
    // Fallback si UI n'est pas disponible
    updateBasicUI();
}

function updateBasicUI() {
    // Mise √† jour basique des √©l√©ments essentiels
    const elements = {
        playerGold: document.getElementById('playerGold'),
        playerCrystals: document.getElementById('playerCrystals'),
        totalSummons: document.getElementById('totalSummons'),
        uniqueCount: document.getElementById('uniqueCount'),
        legendaryCount: document.getElementById('legendaryCount')
    };
    
    if (elements.playerGold) elements.playerGold.textContent = gameState.playerGold;
    if (elements.playerCrystals) elements.playerCrystals.textContent = gameState.crystals;
    if (elements.totalSummons) elements.totalSummons.textContent = gameState.totalSummons;
    if (elements.uniqueCount) elements.uniqueCount.textContent = gameState.ownedCharacters.size;
    if (elements.legendaryCount) elements.legendaryCount.textContent = gameState.legendaryCount;
}

function startAutoSave() {
    if (typeof SaveSystem === 'undefined') return;
    
    setInterval(() => {
        SaveSystem.autoSave();
    }, 30000); // 30 secondes
    
    console.log('üíæ Sauvegarde automatique activ√©e (30s)');
}

function setupGlobalEventListeners() {
    console.log('üéÆ Configuration des gestionnaires d\'√©v√©nements...');
    
    // Helper function pour ajouter des listeners de fa√ßon s√©curis√©e
    function safeAddEventListener(elementId, event, handler) {
        const element = document.getElementById(elementId);
        if (element) {
            element.addEventListener(event, handler);
            console.log(`‚úÖ Event listener ajout√©: ${elementId}`);
        } else {
            console.warn(`‚ö†Ô∏è √âl√©ment non trouv√©: ${elementId}`);
        }
    }
    
    // Gestion des onglets
    safeAddEventListener('tabInvocation', 'click', () => {
        if (typeof UI !== 'undefined') UI.switchTab('invocation');
    });
    
    safeAddEventListener('tabCollection', 'click', () => {
        if (typeof UI !== 'undefined') UI.switchTab('collection');
    });
    
    safeAddEventListener('tabCombat', 'click', () => {
        if (typeof UI !== 'undefined') UI.switchTab('combat');
        if (typeof CombatSystem !== 'undefined') CombatSystem.updateCombatInfo();
    });

    // Ajouter cette ligne avec les autres gestionnaires d'onglets
    safeAddEventListener('tabEquipment', 'click', () => {
        if (typeof UI !== 'undefined' && UI.switchTab) {
            UI.switchTab('equipment');
        }
        if (typeof UI !== 'undefined' && UI.updateEquipmentTab) {
            UI.updateEquipmentTab();
        }
        // EventManager.emit('tab_changed', 'equipment');
    });
    
    // Boutons de sauvegarde
    safeAddEventListener('saveBtn', 'click', () => {
        if (typeof SaveSystem !== 'undefined') SaveSystem.saveGame();
    });
    
    safeAddEventListener('loadBtn', 'click', () => {
        if (typeof SaveSystem !== 'undefined') SaveSystem.loadGame();
    });
    
    safeAddEventListener('deleteBtn', 'click', () => {
        if (typeof SaveSystem !== 'undefined') SaveSystem.deleteSave();
    });
    
    // Bouton de reset
    safeAddEventListener('resetBtn', 'click', resetGame);
    
    // Bouton d'invocation
    safeAddEventListener('summonBtn', 'click', () => {
        if (typeof GachaSystem !== 'undefined') {
            GachaSystem.summon10();
        } else {
            console.log('üé≤ Syst√®me Gacha non disponible');
        }
    });
    
    // Filtres de collection
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const filter = e.target.dataset.filter;
            if (typeof CollectionSystem !== 'undefined') {
                CollectionSystem.filterCollection(filter);
            }
        });
    });
    
    // Fermeture de la modal
    safeAddEventListener('closeModal', 'click', () => {
        if (typeof UI !== 'undefined') UI.closeCharacterModal();
    });
    
    // Clic en dehors de la modal
    window.addEventListener('click', (e) => {
        const modal = document.getElementById('characterModal');
        if (modal && e.target === modal && typeof UI !== 'undefined') {
            UI.closeCharacterModal();
        }
    });
    
    // Gestion de la fermeture de page
    window.addEventListener('beforeunload', () => {
        if (typeof SaveSystem !== 'undefined' && GAME_CONFIG && GAME_CONFIG.SAVE && GAME_CONFIG.SAVE.AUTO_SAVE) {
            SaveSystem.autoSave();
        }
    });

    safeAddEventListener('closeInventoryModal', 'click', () => {
    if (typeof UI !== 'undefined' && UI.closeInventoryModal) {
        UI.closeInventoryModal();
    }
    });
    
    console.log('üéÆ Gestionnaires d\'√©v√©nements configur√©s');
}

function setupBasicEventListeners() {
    // Version simplifi√©e pour le mode de r√©cup√©ration
    const summonBtn = document.getElementById('summonBtn');
    if (summonBtn) {
        summonBtn.addEventListener('click', () => {
            console.log('üé≤ Invocation demand√©e (mode basique)');
            alert('Syst√®me de jeu en cours de chargement...');
        });
    }
}

function resetGame() {
    if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir r√©initialiser compl√®tement le jeu ?\nToutes vos donn√©es seront perdues !')) {
        // Arr√™ter toutes les missions
        if (typeof CombatSystem !== 'undefined') {
            CombatSystem.stopAllMissions();
        }
        
        // Cr√©er un nouveau jeu
        createNewGame();
        
        // Mettre √† jour l'interface
        updateAllUI();
        
        // Sauvegarder
        if (typeof SaveSystem !== 'undefined') {
            SaveSystem.autoSave();
        }
        
        if (typeof UI !== 'undefined') {
            UI.showNotification('üîÑ Jeu r√©initialis√© !', 'success');
        }
        console.log('üîÑ Jeu r√©initialis√©');
    }
}

// Fonctions utilitaires globales
window.GameUtils = {
    getGameState: () => gameState,
    addCrystals: (amount) => {
        gameState.crystals += amount;
        updateBasicUI();
        console.log(`üíé +${amount} cristaux ajout√©s`);
    },
    addGold: (amount) => {
        gameState.playerGold += amount;
        updateBasicUI();
        console.log(`üí∞ +${amount} or ajout√©`);
    }
};

// Exposer les modules principaux pour l'acc√®s externe
window.Game = {
    state: gameState,
    config: typeof GAME_CONFIG !== 'undefined' ? GAME_CONFIG : null,
    utils: window.GameUtils
};

console.log('üéÆ Main.js charg√© avec gestion d\'erreurs am√©lior√©e');